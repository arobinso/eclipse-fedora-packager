<?xml version="1.0" encoding="UTF-8"?>
<project name="org.fedoraproject.eclipse.packager.doc" default="all">
	<description>
            Generate Eclipse help content from the Eclipsepedia wiki
    </description>

	<property name="help.doc.url.base" value="https://fedoraproject.org/w" />
	<property name="wiki.url.base" value="${help.doc.url.base}" />
	<property name="outputFolder" value="userguide" />
	<property name="imageFolder" value="images" />

	<path id="wikitext.tasks.classpath">
		<fileset dir="/usr/share/eclipse/dropins/mylyn-docs-wikitext/eclipse/plugins">
					<include name="org.eclipse.mylyn.wikitext.*core*.jar" />
		</fileset>
	</path>

	<taskdef classpathref="wikitext.tasks.classpath" resource="org/eclipse/mylyn/internal/wikitext/mediawiki/core/tasks/tasks.properties" />
	<taskdef classpathref="wikitext.tasks.classpath" resource="org/eclipse/mylyn/wikitext/core/util/anttask/tasks.properties" />

	<target name="init">
		<mkdir dir="tmp" />
	</target>

	<target name="clean" depends="init">
		<delete includeemptydirs="true" failonerror="false">
			<fileset dir="tmp" />
		</delete>
	</target>

	<target name="all" depends="generate-help" />

	<target name="generate-help" depends="init" description="Create a user guide for maintainers of fedora packages">
		<sequential>
            <delete failonerror="false">
               <fileset dir="${basedir}/${outputFolder}/images" />
            </delete>
			<mediawiki-to-eclipse-help wikiBaseUrl="${help.doc.url.base}"

				prependImagePrefix="${imageFolder}"
				helpprefix="${outputFolder}"
				formatoutput="true"
				navigationimages="true"
				dest="${outputFolder}"
				title="Eclipse Fedora Packager User Guide"
				fetchimages="true">
				
				<path name="Eclipse_Fedora_Packager_User_Guide" title="Fedora Packager User Guide" generateToc="true" />
				<stylesheet url="book.css" />
				<pageAppendum>
= Updating This Document =

This document is maintained in a collaborative wiki.  If you wish to update or modify this document please visit 
https://fedoraproject.org/wiki/Eclipse_Fedora_Packager_User_Guide
    	  		</pageAppendum>
			</mediawiki-to-eclipse-help>
			<mkdir dir="${basedir}/${outputFolder}/images" />
            <copy todir="${basedir}/${outputFolder}/images" overwrite="true">
                <fileset dir="images" />
            </copy>
		</sequential>
	</target>

	<!--
	Internal links to this user-guide should be revised in the .html page after they are created.
	e.g. 
	<a href="https://fedoraproject.org/wiki/Eclipse_Fedora_Packager_User_Guide#Switching_Branches_.28Git_Checkout.29">checkout</a>
	should be changed to
	<a href="Using-Eclipse-Fedorapackager.html#Switching_Branches_.28Git_Checkout.29">checkout</a>
	-->
	<target name="test" depends="init" description="verify that all of the HTML files are well-formed XML">
		<echo level="info">
Validating help content XML and HTML files: The Eclipse help system expects well-formed XML

If validation fails it is because either:

* the userguide source code is poorly formed, or
* the WikiText MediaWiki parser has a bug

Problems with userguide source are usually caused by improper use of HTML markup in the MediaWiki source,
or inadvertently starting a line with a space character (in MediaWiki this starts a preformatted block)
		</echo>

		<!--
		Don't bother with DTD validation: we only care if the files are well-formed.
		We therefore provide an empty DTD 
		-->
		<echo file="tmp/__empty.dtd" message="" />
		<xmlvalidate lenient="true">
			<fileset dir="${basedir}/userguide">
				<include name="**/*.xml" />
				<include name="**/*.html" />
			</fileset>
			<dtd publicid="-//W3C//DTD XHTML 1.0 Transitional//EN" location="${basedir}/tmp/__empty.dtd" />
		</xmlvalidate>
	</target>
</project>
